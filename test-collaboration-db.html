<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaboration Database Test - EDUConnect</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.5); }
        .error { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); }
        .info { background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5); }
        .warning { background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.5); }
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .data-display {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .table-container {
            overflow-x: auto;
            margin: 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        th {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: white;
        }
        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ù Collaboration Database Test - EDUConnect</h1>
        <p>Testing real-time collaboration features and database connectivity</p>

        <div class="test-section">
            <h3>üîß Database Connection</h3>
            <div id="connection-status" class="status info">
                <strong>Status:</strong> <span id="connection-text">Testing connection...</span>
            </div>
            <button onclick="testConnection()">Test Connection</button>
        </div>

        <div class="test-section">
            <h3>üìä Database Statistics</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="users-count">-</div>
                    <div class="stat-label">Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="messages-count">-</div>
                    <div class="stat-label">Messages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="groups-count">-</div>
                    <div class="stat-label">Study Groups</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="requests-count">-</div>
                    <div class="stat-label">Help Requests</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>üë• User Management</h3>
            <button onclick="testUserCreation()">Test User Creation</button>
            <button onclick="testUserRetrieval()">Test User Retrieval</button>
            <button onclick="testUserUpdate()">Test User Update</button>
            <div id="user-results" class="data-display" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üí¨ Messaging System</h3>
            <button onclick="testMessageCreation()">Test Message Creation</button>
            <button onclick="testMessageRetrieval()">Test Message Retrieval</button>
            <button onclick="testRealTimeMessages()">Test Real-time Messages</button>
            <div id="message-results" class="data-display" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üë• Study Groups</h3>
            <button onclick="testGroupCreation()">Test Group Creation</button>
            <button onclick="testGroupRetrieval()">Test Group Retrieval</button>
            <button onclick="testGroupMembership()">Test Group Membership</button>
            <div id="group-results" class="data-display" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üÜò Help Requests</h3>
            <button onclick="testHelpRequestCreation()">Test Help Request Creation</button>
            <button onclick="testHelpRequestRetrieval()">Test Help Request Retrieval</button>
            <button onclick="testHelpRequestResponse()">Test Help Request Response</button>
            <div id="help-results" class="data-display" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üì° Real-time Features</h3>
            <button onclick="testPresenceSystem()">Test Presence System</button>
            <button onclick="testRealTimeUpdates()">Test Real-time Updates</button>
            <button onclick="testNotifications()">Test Notifications</button>
            <div id="realtime-results" class="data-display" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üîç Test Results</h3>
            <div id="test-results" class="status info">
                <strong>Results:</strong> <span id="results-text">No tests run yet</span>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://nhuxwgmafdjchljvqlna.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5odXh3Z21hZmRqY2hsanZxbG5hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE5NzI5NzAsImV4cCI6MjA0NzU0ODk3MH0.304df104-ec95-4b0b-ae4a-2babbc3d9fcd';

        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let testResults = [];

        // Initialize the test
        async function initializeTest() {
            await testConnection();
            await updateDatabaseStats();
            updateResults('Test initialized successfully');
        }

        // Test database connection
        async function testConnection() {
            try {
                updateConnectionStatus('Testing connection...', 'info');
                
                // Test basic connection
                const { data, error } = await supabase.from('profiles').select('count').limit(1);
                
                if (error) {
                    updateConnectionStatus(`Connection failed: ${error.message}`, 'error');
                    addTestResult('Database Connection', 'Failed', 'fail');
                } else {
                    updateConnectionStatus('Connection successful!', 'success');
                    addTestResult('Database Connection', 'Successful', 'pass');
                }
            } catch (error) {
                updateConnectionStatus(`Connection error: ${error.message}`, 'error');
                addTestResult('Database Connection', 'Error', 'fail');
            }
        }

        // Update connection status
        function updateConnectionStatus(message, type) {
            document.getElementById('connection-text').textContent = message;
            document.getElementById('connection-status').className = `status ${type}`;
        }

        // Update database statistics
        async function updateDatabaseStats() {
            try {
                // Get users count
                const { count: usersCount } = await supabase.from('profiles').select('*', { count: 'exact', head: true });
                document.getElementById('users-count').textContent = usersCount || 0;

                // Get messages count
                const { count: messagesCount } = await supabase.from('messages').select('*', { count: 'exact', head: true });
                document.getElementById('messages-count').textContent = messagesCount || 0;

                // Get groups count
                const { count: groupsCount } = await supabase.from('study_groups').select('*', { count: 'exact', head: true });
                document.getElementById('groups-count').textContent = groupsCount || 0;

                // Get help requests count
                const { count: requestsCount } = await supabase.from('help_requests').select('*', { count: 'exact', head: true });
                document.getElementById('requests-count').textContent = requestsCount || 0;

            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Test user creation
        async function testUserCreation() {
            try {
                const testUser = {
                    id: 'test-user-' + Date.now(),
                    email: 'test@example.com',
                    full_name: 'Test User',
                    role: 'student',
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabase.from('profiles').insert(testUser);

                if (error) {
                    showResults('user-results', 'User Creation Failed', error.message, 'error');
                    addTestResult('User Creation', 'Failed', 'fail');
                } else {
                    showResults('user-results', 'User Creation Successful', JSON.stringify(data, null, 2), 'success');
                    addTestResult('User Creation', 'Successful', 'pass');
                }
            } catch (error) {
                showResults('user-results', 'User Creation Error', error.message, 'error');
                addTestResult('User Creation', 'Error', 'fail');
            }
        }

        // Test user retrieval
        async function testUserRetrieval() {
            try {
                const { data, error } = await supabase.from('profiles').select('*').limit(5);

                if (error) {
                    showResults('user-results', 'User Retrieval Failed', error.message, 'error');
                    addTestResult('User Retrieval', 'Failed', 'fail');
                } else {
                    showResults('user-results', 'User Retrieval Successful', JSON.stringify(data, null, 2), 'success');
                    addTestResult('User Retrieval', 'Successful', 'pass');
                }
            } catch (error) {
                showResults('user-results', 'User Retrieval Error', error.message, 'error');
                addTestResult('User Retrieval', 'Error', 'fail');
            }
        }

        // Test user update
        async function testUserUpdate() {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .update({ updated_at: new Date().toISOString() })
                    .eq('email', 'test@example.com')
                    .select();

                if (error) {
                    showResults('user-results', 'User Update Failed', error.message, 'error');
                    addTestResult('User Update', 'Failed', 'fail');
                } else {
                    showResults('user-results', 'User Update Successful', JSON.stringify(data, null, 2), 'success');
                    addTestResult('User Update', 'Successful', 'pass');
                }
            } catch (error) {
                showResults('user-results', 'User Update Error', error.message, 'error');
                addTestResult('User Update', 'Error', 'fail');
            }
        }

        // Test message creation
        async function testMessageCreation() {
            try {
                const testMessage = {
                    sender_id: 'test-user-123',
                    receiver_id: 'test-user-456',
                    content: 'Test message from collaboration test',
                    message_type: 'text',
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabase.from('messages').insert(testMessage);

                if (error) {
                    showResults('message-results', 'Message Creation Failed', error.message, 'error');
                    addTestResult('Message Creation', 'Failed', 'fail');
                } else {
                    showResults('message-results', 'Message Creation Successful', JSON.stringify(data, null, 2), 'success');
                    addTestResult('Message Creation', 'Successful', 'pass');
                }
            } catch (error) {
                showResults('message-results', 'Message Creation Error', error.message, 'error');
                addTestResult('Message Creation', 'Error', 'fail');
            }
        }

        // Test message retrieval
        async function testMessageRetrieval() {
            try {
                const { data, error } = await supabase.from('messages').select('*').limit(5);

                if (error) {
                    showResults('message-results', 'Message Retrieval Failed', error.message, 'error');
                    addTestResult('Message Retrieval', 'Failed', 'fail');
                } else {
                    showResults('message-results', 'Message Retrieval Successful', JSON.stringify(data, null, 2), 'success');
                    addTestResult('Message Retrieval', 'Successful', 'pass');
                }
            } catch (error) {
                showResults('message-results', 'Message Retrieval Error', error.message, 'error');
                addTestResult('Message Retrieval', 'Error', 'fail');
            }
        }

        // Test real-time messages
        async function testRealTimeMessages() {
            try {
                const subscription = supabase
                    .channel('messages')
                    .on('postgres_changes', 
                        { event: 'INSERT', schema: 'public', table: 'messages' },
                        (payload) => {
                            showResults('message-results', 'Real-time Message Received', JSON.stringify(payload, null, 2), 'success');
                            addTestResult('Real-time Messages', 'Working', 'pass');
                        }
                    )
                    .subscribe();

                showResults('message-results', 'Real-time Subscription Active', 'Listening for new messages...', 'info');
                addTestResult('Real-time Messages', 'Subscription Active', 'pass');

                // Cleanup subscription after 10 seconds
                setTimeout(() => {
                    subscription.unsubscribe();
                }, 10000);

            } catch (error) {
                showResults('message-results', 'Real-time Messages Error', error.message, 'error');
                addTestResult('Real-time Messages', 'Error', 'fail');
            }
        }

        // Test group creation
        async function testGroupCreation() {
            try {
                const testGroup = {
                    name: 'Test Study Group',
                    description: 'A test study group for collaboration testing',
                    created_by: 'test-user-123',
                    subject: 'Computer Science',
                    max_members: 10,
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabase.from('study_groups').insert(testGroup);

                if (error) {
                    showResults('group-results', 'Group Creation Failed', error.message, 'error');
                    addTestResult('Group Creation', 'Failed', 'fail');
                } else {
                    showResults('group-results', 'Group Creation Successful', JSON.stringify(data, null, 2), 'success');
                    addTestResult('Group Creation', 'Successful', 'pass');
                }
            } catch (error) {
                showResults('group-results', 'Group Creation Error', error.message, 'error');
                addTestResult('Group Creation', 'Error', 'fail');
            }
        }

        // Test group retrieval
        async function testGroupRetrieval() {
            try {
                const { data, error } = await supabase.from('study_groups').select('*').limit(5);

                if (error) {
                    showResults('group-results', 'Group Retrieval Failed', error.message, 'error');
                    addTestResult('Group Retrieval', 'Failed', 'fail');
                } else {
                    showResults('group-results', 'Group Retrieval Successful', JSON.stringify(data, null, 2), 'success');
                    addTestResult('Group Retrieval', 'Successful', 'pass');
                }
            } catch (error) {
                showResults('group-results', 'Group Retrieval Error', error.message, 'error');
                addTestResult('Group Retrieval', 'Error', 'fail');
            }
        }

        // Test group membership
        async function testGroupMembership() {
            try {
                const testMembership = {
                    group_id: 1,
                    user_id: 'test-user-123',
                    role: 'member',
                    joined_at: new Date().toISOString()
                };

                const { data, error } = await supabase.from('study_group_members').insert(testMembership);

                if (error) {
                    showResults('group-results', 'Group Membership Failed', error.message, 'error');
                    addTestResult('Group Membership', 'Failed', 'fail');
                } else {
                    showResults('group-results', 'Group Membership Successful', JSON.stringify(data, null, 2), 'success');
                    addTestResult('Group Membership', 'Successful', 'pass');
                }
            } catch (error) {
                showResults('group-results', 'Group Membership Error', error.message, 'error');
                addTestResult('Group Membership', 'Error', 'fail');
            }
        }

        // Test help request creation
        async function testHelpRequestCreation() {
            try {
                const testRequest = {
                    requester_id: 'test-user-123',
                    subject: 'Mathematics',
                    topic: 'Calculus',
                    description: 'Need help with derivatives',
                    urgency: 'medium',
                    status: 'open',
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabase.from('help_requests').insert(testRequest);

                if (error) {
                    showResults('help-results', 'Help Request Creation Failed', error.message, 'error');
                    addTestResult('Help Request Creation', 'Failed', 'fail');
                } else {
                    showResults('help-results', 'Help Request Creation Successful', JSON.stringify(data, null, 2), 'success');
                    addTestResult('Help Request Creation', 'Successful', 'pass');
                }
            } catch (error) {
                showResults('help-results', 'Help Request Creation Error', error.message, 'error');
                addTestResult('Help Request Creation', 'Error', 'fail');
            }
        }

        // Test help request retrieval
        async function testHelpRequestRetrieval() {
            try {
                const { data, error } = await supabase.from('help_requests').select('*').limit(5);

                if (error) {
                    showResults('help-results', 'Help Request Retrieval Failed', error.message, 'error');
                    addTestResult('Help Request Retrieval', 'Failed', 'fail');
                } else {
                    showResults('help-results', 'Help Request Retrieval Successful', JSON.stringify(data, null, 2), 'success');
                    addTestResult('Help Request Retrieval', 'Successful', 'pass');
                }
            } catch (error) {
                showResults('help-results', 'Help Request Retrieval Error', error.message, 'error');
                addTestResult('Help Request Retrieval', 'Error', 'fail');
            }
        }

        // Test help request response
        async function testHelpRequestResponse() {
            try {
                const testResponse = {
                    request_id: 1,
                    responder_id: 'test-user-456',
                    response: 'I can help you with derivatives!',
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabase.from('help_request_responses').insert(testResponse);

                if (error) {
                    showResults('help-results', 'Help Request Response Failed', error.message, 'error');
                    addTestResult('Help Request Response', 'Failed', 'fail');
                } else {
                    showResults('help-results', 'Help Request Response Successful', JSON.stringify(data, null, 2), 'success');
                    addTestResult('Help Request Response', 'Successful', 'pass');
                }
            } catch (error) {
                showResults('help-results', 'Help Request Response Error', error.message, 'error');
                addTestResult('Help Request Response', 'Error', 'fail');
            }
        }

        // Test presence system
        async function testPresenceSystem() {
            try {
                const testPresence = {
                    user_id: 'test-user-123',
                    status: 'online',
                    last_seen: new Date().toISOString(),
                    expertise_areas: ['Mathematics', 'Physics']
                };

                const { data, error } = await supabase.from('user_presence').upsert(testPresence);

                if (error) {
                    showResults('realtime-results', 'Presence System Failed', error.message, 'error');
                    addTestResult('Presence System', 'Failed', 'fail');
                } else {
                    showResults('realtime-results', 'Presence System Working', JSON.stringify(data, null, 2), 'success');
                    addTestResult('Presence System', 'Working', 'pass');
                }
            } catch (error) {
                showResults('realtime-results', 'Presence System Error', error.message, 'error');
                addTestResult('Presence System', 'Error', 'fail');
            }
        }

        // Test real-time updates
        async function testRealTimeUpdates() {
            try {
                const subscription = supabase
                    .channel('presence')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'user_presence' },
                        (payload) => {
                            showResults('realtime-results', 'Real-time Update Received', JSON.stringify(payload, null, 2), 'success');
                            addTestResult('Real-time Updates', 'Working', 'pass');
                        }
                    )
                    .subscribe();

                showResults('realtime-results', 'Real-time Updates Active', 'Listening for presence changes...', 'info');
                addTestResult('Real-time Updates', 'Subscription Active', 'pass');

                // Cleanup subscription after 10 seconds
                setTimeout(() => {
                    subscription.unsubscribe();
                }, 10000);

            } catch (error) {
                showResults('realtime-results', 'Real-time Updates Error', error.message, 'error');
                addTestResult('Real-time Updates', 'Error', 'fail');
            }
        }

        // Test notifications
        async function testNotifications() {
            try {
                const testNotification = {
                    user_id: 'test-user-123',
                    title: 'Test Notification',
                    message: 'This is a test notification from the collaboration system',
                    type: 'info',
                    read: false,
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabase.from('notifications').insert(testNotification);

                if (error) {
                    showResults('realtime-results', 'Notifications Failed', error.message, 'error');
                    addTestResult('Notifications', 'Failed', 'fail');
                } else {
                    showResults('realtime-results', 'Notifications Working', JSON.stringify(data, null, 2), 'success');
                    addTestResult('Notifications', 'Working', 'pass');
                }
            } catch (error) {
                showResults('realtime-results', 'Notifications Error', error.message, 'error');
                addTestResult('Notifications', 'Error', 'fail');
            }
        }

        // Show results in a specific container
        function showResults(containerId, title, content, type) {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            container.innerHTML = `
                <h4>${title}</h4>
                <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; overflow-x: auto;">${content}</pre>
            `;
        }

        // Add test result
        function addTestResult(testName, result, status) {
            testResults.push({ testName, result, status });
            updateResults();
        }

        // Update results display
        function updateResults(message = '') {
            const passed = testResults.filter(r => r.status === 'pass').length;
            const failed = testResults.filter(r => r.status === 'fail').length;
            const total = testResults.length;

            let resultsText = `Tests: ${passed} passed, ${failed} failed (${total} total)`;
            if (message) {
                resultsText += ` | ${message}`;
            }

            document.getElementById('results-text').textContent = resultsText;
        }

        // Initialize when page loads
        window.addEventListener('load', initializeTest);
    </script>
</body>
</html> 